box:
  id: quay.io/wacul/node-nightmare
  registry: https://quay.io
  tag: latest
no-response-timeout: 15

build:
  steps:
    - script:
      name: show master hash
      code: |
        git remote set-url origin https://github.com/$WERCKER_GIT_OWNER/$WERCKER_GIT_REPOSITORY.git
        hash=`git rev-parse master`
        echo $hash

    - script:
      name: install yarn
      code: |
        npm install -g yarn

    - script:
      name: set yarn cache
      code: |
        export YARN_CACHE=$WERCKER_CACHE_DIR/yarn

    - script:
      name: install dependencies
      code: |
        HOME=$YARN_CACHE yarn

    - script:
      name: set timezone
      code: |
        export TZ="Asia/Tokyo"

    - script:
      name: start xvfb daemon
      code: |
        export DISPLAY=':99.0'
        xvfbd start

    - script:
      name: run karma
      code: npm run test

    - script:
      name: stop xvfb daemon
      code: xvfbd stop

    - pip-install:
        requirements_file: ""
        pip_command: "pip3"
        packages_list: "awscli"

    - script:
      name: set environment
      code: |
        export AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
        export AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}

    - script:
      name: create reg.json
      code: node scripts/report.js

    - script:
      name: upload reg.json
      code: |
        aws s3 cp screenshot s3://flownes/$WERCKER_GIT_COMMIT --recursive --exclude "*" --include "*.json" --content-type application/json --acl public-read

    - script:
      name: sync expected
      code: |
        git remote set-url origin https://github.com/$WERCKER_GIT_OWNER/$WERCKER_GIT_REPOSITORY.git
        hash=`git rev-parse master`      
        aws s3 stnc s3://flownes/$hash screenshot/expected

    - script:
      name: s3 upload
      code: |
        aws s3 cp screenshot/actual s3://flownes/$WERCKER_GIT_COMMIT --recursive --exclude "*" --include "*.png" --content-type image/png --acl public-read
        aws s3 cp screenshot/expected s3://flownes/$WERCKER_GIT_COMMIT --recursive --exclude "*" --include "*.png" --content-type image/png --acl public-read

  # after-steps:
  #   - wantedly/pretty-slack-notify:
  #     webhook_url: $SLACK_URL
  #     channel: $SLACK_CHANNEL
  #     username: wercker
  #     passed_message: Screenshot report url is https://s3.amazonaws.com/ai-analyst-ocha-snapshot/$WERCKER_GIT_COMMIT
